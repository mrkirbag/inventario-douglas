---
import Layout from '../../layouts/Layout.astro';
import { verificarToken } from '../../utils/auth.js';

const usuario = verificarToken(Astro.request);
if (!usuario) {
    return Astro.redirect('/login');
}
if (usuario.rol !== 'admin') {
    return Astro.redirect('/'); 
}
---

<Layout>
    <h1>Agregar Usuario</h1>

    <div class="btn-add_container">
        <a class="btn-add" href="/usuarios">Regresar</a>
    </div>

    <section class="form-container">
        <form id="formulario">
            <div>
                <input type="text" name="nombre" id="nombre" placeholder="Nombre y Apellido" />
            </div>
            <div>
                <input type="text" name="usuario" id="usuario" placeholder="Usuario" autocomplete="username"/>
            </div>
            <div>
                <select name="rol" id="rol">
                    <option value="" disabled selected>Seleccionar rol</option>
                    <option value="admin">Administrador</option>
                    <option value="empleado">Empleado</option>
                </select>
            </div>
            <div class="password-container">
                <input type="password" name="contrasena" id="contrasena" placeholder="Contraseña" autocomplete="new-password"/>
                <span id="verContrasena">👁️</span>
            </div>
            <div class="password-container">
                <input type="password" name="contrasena2" id="contrasena2" placeholder="Repetir contraseña" autocomplete="new-password"/>
                <span id="verContrasena2">👁️</span>
            </div>
            <button type="submit">Agregar</button>
        </form>
    </section>

    <div id="mensaje"></div>
</Layout>

<script type="module">

    import { mostrarError, mostrarMensaje } from '/mensajes.js';

    const btnVerContrasena = document.querySelector("#verContrasena");
    const btnVerContrasena2 = document.querySelector("#verContrasena2");

    btnVerContrasena.addEventListener('click', () => {
        const contrasena = document.querySelector("#contrasena");
        contrasena.type = contrasena.type === 'password' ? 'text' : 'password';
    });

    btnVerContrasena2.addEventListener('click', () => {
        const contrasena2 = document.querySelector("#contrasena2");
        contrasena2.type = contrasena2.type === 'password' ? 'text' : 'password';
    });

    const formulario = document.getElementById('formulario');

    formulario.addEventListener('submit', async (event) => { 
        
        event.preventDefault();
        
        const nombre = document.getElementById('nombre').value;
        const usuario = document.getElementById('usuario').value;
        const contrasena = document.getElementById('contrasena').value;
        const contrasena2 = document.getElementById('contrasena2').value;
        const rol = document.getElementById('rol').value;

        // Validar que las contrasenas coincidan
        if(contrasena !== contrasena2){
            mostrarError('Las contraseñas no coinciden');
            return;
        }

        // Validar campos vacios
        if (nombre === '' || usuario === '' || contrasena === '' || contrasena2 === '' || rol === '') {
            mostrarError('Todos los campos son obligatorios.'); 
            return;
        }

        try{
            const response = await fetch("/api/usuarios/registrar", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ nombre, usuario, contrasena, rol })
            });

            if(!response.ok){
                throw new Error('Error al agregar usuario: ' + response.status);
            } else {
                mostrarMensaje('Usuario agregado exitosamente.');
                setTimeout(() => {
                    window.location.href = '/usuarios';
                }, 1000);
            }

        } catch(error){
            console.error(error);
        }
    });