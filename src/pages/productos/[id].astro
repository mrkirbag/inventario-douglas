---
import Layout from '../../layouts/Layout.astro';
import { verificarToken } from '../../utils/auth.js';

const usuario = verificarToken(Astro.request);
if (!usuario) {
    return Astro.redirect('/login');
}
if (usuario.rol !== 'admin') {
    return Astro.redirect('/'); 
}

const {id} = Astro.params;
---

<Layout>
    <h1>Editar Producto</h1>

    <div class="btn-add_container">
        <a class="btn-add" href="/productos">Regresar</a>
    </div>

    <section class="form-container">
        <form id="formulario">
            <div>
                <label for="codigo">Código</label>
                <input type="text" name="codigo" id="codigo" placeholder="Código del Producto" />
            </div>
            <div>
                <label for="nombre">Nombre</label>
                <input type="text" name="nombre" id="nombre" placeholder="Nombre" />
            </div>
            <div>
                <label for="stock">Stock actual</label>
                <input type="number" name="stock" id="stock" placeholder="Cantidad de Stock Inicial" min="0"/>
            </div>
            <div>
                <label for="costo">Precio de costo</label>
                <input type="text" name="costo" id="costo" placeholder="Precio de Costo en USD" min="0"/>
            </div>
            <div>
                <label for="venta">Precio de venta</label>
                <input type="text" name="venta" id="venta" placeholder="Precio de Venta en USD" min="0"/>
            </div>

            <button type="submit">Actualizar</button>
        </form>
    </section>

    <div id="mensaje"></div>
</Layout>

<script type="module" is:inline>

    import { mostrarError, mostrarMensaje } from '/mensajes.js';

    // Rellenar campos con los datos existentes
    const id = location.pathname.split("/").pop();
    const nombre = document.querySelector("#nombre");
    const codigo = document.querySelector("#codigo");
    const stock = document.querySelector("#stock");
    const costo = document.querySelector("#costo");
    const venta = document.querySelector("#venta");
    
    document.addEventListener('DOMContentLoaded', rellenarCampos);

    async function rellenarCampos(){

        const response = await fetch(`/api/productos/${id}`);
        const producto = await response.json();

        codigo.value = producto.codigo;
        nombre.value = producto.nombre;
        stock.value = producto.stock;
        costo.value = producto.costo;
        venta.value = producto.venta;
    }

    const formulario = document.getElementById('formulario');

    formulario.addEventListener('submit', async (event) => { 
        
        event.preventDefault();
        
        const id = location.pathname.split("/").pop();
        const codigo = document.getElementById('codigo').value;
        const nombre = document.getElementById('nombre').value;
        const stockString = document.getElementById('stock').value;
        const costoString = document.getElementById('costo').value;
        const ventaString = document.getElementById('venta').value;


        // Validar campos vacios
        if (codigo === '' || nombre === '' || stockString === '' || costoString === '' || ventaString === '') {
            mostrarError('Todos los campos son obligatorios.');
            return;
        }

        // Validar stock
        const stockValido = /^\d+$/.test(stockString);
        if (!stockValido || parseInt(stockString) <= 0) {
            mostrarError('La cantidad en stock debe ser un número positivo mayor a 0.');
            return;
        }

        // Validar costo
        const costoNum = parseFloat(costoString.replace(',', '.'));
        if (isNaN(costoNum) || costoNum <= 0) {
            mostrarError('El costo debe ser un número positivo mayor a 0.');
            return;
        }

        // Validar precio venta
        const ventaNum = parseFloat(ventaString.replace(',', '.'));
        if (isNaN(ventaNum) || ventaNum <= 0) {
            mostrarError('El precio de venta debe ser un número positivo mayor a 0.');
            return;
        }

        // Parseo
        const stock = parseInt(stockString);
        const costo = costoNum;
        const venta = ventaNum;

        // Enviar datos al servidor
        const response = await fetch("/api/productos", {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ id, codigo, nombre, stock, costo, venta }),
        });

        // Verificar si la respuesta es exitosa
        if (!response.ok) {
            if (response.status === 409) {
                const mensaje = await response.text();
                mostrarError(mensaje);
            } else {
                mostrarError('Error al editar producto: ' + response.status);
            }
            return;
        }

        const data = await response.json();
        mostrarMensaje(data.message);
        setTimeout(() => {
            window.location.href = '/productos';
        }, 1000);
    });
</script>